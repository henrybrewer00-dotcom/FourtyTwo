{% extends "base.html" %}

{% block title %}Lobby - GAME 42{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/lobby.css') }}">
{% endblock %}

{% block content %}
<div class="lobby-container">
    <div class="lobby-header">
        <h1>Game Lobby</h1>
        <button id="create-game-btn" class="btn btn-primary">Create New Game</button>
    </div>

    <div class="lobby-content">
        <div class="games-section">
            <div class="section-header">
                <h2>Public Games</h2>
                <div class="header-actions">
                    <button id="join-private-btn" class="btn btn-small">Join Private Game</button>
                    <button id="refresh-btn" class="btn btn-small">Refresh</button>
                </div>
            </div>

            <div id="games-list" class="games-list">
                <div class="loading">Loading games...</div>
            </div>
        </div>

        <div class="rules-section">
            <h2>Texas 42 Rules</h2>
            <div class="rules-content">
                <h3>Overview</h3>
                <p>Texas 42 is a trick-taking domino game for 4 players in 2 teams.</p>

                <h3>Objective</h3>
                <p>First team to reach 7 marks wins. Each hand has 42 points available.</p>

                <h3>Bidding</h3>
                <p>Bid 30-42 points. Highest bidder selects trump suit.</p>

                <h3>Playing</h3>
                <p>Follow the led suit if possible. Highest domino wins the trick.</p>

                <h3>Count Dominoes</h3>
                <ul>
                    <li>5-0, 4-1, 3-2 = 5 points each</li>
                    <li>6-4, 5-5 = 10 points each</li>
                    <li>Each trick = 1 point</li>
                </ul>

                <h3>Scoring</h3>
                <p>Make your bid = earn 1 mark. Get set = opponents earn 1 mark.</p>
            </div>
        </div>
    </div>
</div>

<!-- Create Game Modal -->
<div id="create-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Game</h2>
            <button class="modal-close">&times;</button>
        </div>
        <form id="create-game-form">
            <div class="form-group">
                <label for="game-name">Game Name</label>
                <input type="text" id="game-name" name="name" maxlength="50"
                       placeholder="My Game">
            </div>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="is-public" name="is_public" checked>
                <label for="is-public">Public game (visible in lobby)</label>
            </div>
            <div class="form-error" id="create-error"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Game</button>
            </div>
        </form>
    </div>
</div>

<!-- Join Private Game Modal -->
<div id="join-private-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Join Private Game</h2>
            <button class="modal-close">&times;</button>
        </div>
        <form id="join-private-form">
            <div class="form-group">
                <label for="access-code">Enter Access Code</label>
                <input type="text" id="access-code" name="access_code" maxlength="6"
                       placeholder="ABC123" style="text-transform:uppercase">
            </div>
            <div class="form-error" id="join-error"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                <button type="submit" class="btn btn-primary">Join Game</button>
            </div>
        </form>
    </div>
</div>

<!-- Game Created Modal (with share options) -->
<div id="game-created-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Game Created!</h2>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="access-code-display" style="display:none;">
                <h3>Access Code</h3>
                <div class="access-code-box">
                    <span id="access-code-value" class="access-code"></span>
                    <button class="btn btn-small" id="copy-code-btn">Copy</button>
                </div>
                <p class="hint">Share this code with players to join your private game</p>
            </div>

            <h3>Share Game</h3>
            <div class="share-options">
                <div class="share-link">
                    <input type="text" id="game-link" readonly>
                    <button class="btn btn-small" id="copy-link-btn">Copy Link</button>
                </div>
                <div class="share-buttons">
                    <button class="btn btn-social" id="share-imessage">iMessage</button>
                    <button class="btn btn-social" id="share-native">Share...</button>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-primary" id="goto-game-btn">Go to Game</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const gamesList = document.getElementById('games-list');
    const createModal = document.getElementById('create-modal');
    const createForm = document.getElementById('create-game-form');

    // Load games
    async function loadGames() {
        gamesList.innerHTML = '<div class="loading">Loading games...</div>';

        try {
            const res = await fetch('/api/games');
            const data = await res.json();

            if (data.games.length === 0) {
                gamesList.innerHTML = `
                    <div class="no-games">
                        <p>No games available</p>
                        <p>Create a new game to get started!</p>
                    </div>
                `;
                return;
            }

            gamesList.innerHTML = data.games.map(game => `
                <div class="game-card" data-game-id="${game.game_id}">
                    <div class="game-info">
                        <h3 class="game-name">${escapeHtml(game.name)}</h3>
                        <div class="game-details">
                            <span class="game-players">${game.player_count}/4 players</span>
                            <span class="game-status status-${game.status}">${formatStatus(game.status)}</span>
                        </div>
                        <div class="game-score">
                            Team 1: ${game.team1_marks} marks | Team 2: ${game.team2_marks} marks
                        </div>
                        <div class="game-players-list">
                            ${formatPlayers(game.player_names)}
                        </div>
                    </div>
                    <button class="btn btn-primary join-btn" data-game-id="${game.game_id}">
                        ${game.player_count >= 4 ? 'Spectate' : 'Join'}
                    </button>
                </div>
            `).join('');

            // Add click handlers
            document.querySelectorAll('.join-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    window.location.href = `/game/${btn.dataset.gameId}`;
                });
            });

        } catch (err) {
            gamesList.innerHTML = '<div class="error">Failed to load games</div>';
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatStatus(status) {
        const statusMap = {
            'waiting': 'Waiting',
            'bidding': 'Bidding',
            'trump_selection': 'Selecting Trump',
            'playing': 'In Progress',
            'finished': 'Finished'
        };
        return statusMap[status] || status;
    }

    function formatPlayers(playerNames) {
        if (!playerNames || Object.keys(playerNames).length === 0) {
            return '<span class="no-players">No players yet</span>';
        }
        return Object.entries(playerNames).map(([pos, name]) =>
            `<span class="player-tag">${pos}: ${escapeHtml(name)}</span>`
        ).join('');
    }

    // Initial load
    loadGames();

    // Refresh button
    document.getElementById('refresh-btn').addEventListener('click', loadGames);

    // Auto-refresh every 10 seconds
    setInterval(loadGames, 10000);

    // Create game modal
    document.getElementById('create-game-btn').addEventListener('click', () => {
        createModal.classList.add('active');
    });

    createModal.querySelector('.modal-close').addEventListener('click', () => {
        createModal.classList.remove('active');
    });

    createModal.querySelector('.modal-cancel').addEventListener('click', () => {
        createModal.classList.remove('active');
    });

    createModal.addEventListener('click', (e) => {
        if (e.target === createModal) {
            createModal.classList.remove('active');
        }
    });

    // Create game form
    createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const errorEl = document.getElementById('create-error');
        errorEl.textContent = '';

        const name = document.getElementById('game-name').value || undefined;
        const isPublic = document.getElementById('is-public').checked;

        try {
            const res = await fetch('/api/games', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, is_public: isPublic })
            });
            const data = await res.json();

            if (data.success) {
                // Close create modal
                createModal.classList.remove('active');

                // Show game created modal with share options
                showGameCreatedModal(data.game_id, data.access_code, data.is_public);
            } else {
                errorEl.textContent = data.error || 'Failed to create game';
            }
        } catch (err) {
            errorEl.textContent = 'Connection error. Please try again.';
        }
    });

    // Join private game
    const joinPrivateModal = document.getElementById('join-private-modal');
    const joinPrivateForm = document.getElementById('join-private-form');

    document.getElementById('join-private-btn').addEventListener('click', () => {
        joinPrivateModal.classList.add('active');
    });

    joinPrivateModal.querySelector('.modal-close').addEventListener('click', () => {
        joinPrivateModal.classList.remove('active');
    });

    joinPrivateModal.querySelector('.modal-cancel').addEventListener('click', () => {
        joinPrivateModal.classList.remove('active');
    });

    joinPrivateForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const errorEl = document.getElementById('join-error');
        errorEl.textContent = '';

        const code = document.getElementById('access-code').value.toUpperCase().trim();

        if (!code) {
            errorEl.textContent = 'Please enter an access code';
            return;
        }

        try {
            const res = await fetch(`/api/games/join/${code}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();

            if (data.success) {
                window.location.href = `/game/${data.game_id}`;
            } else {
                errorEl.textContent = data.error || 'Invalid access code';
            }
        } catch (err) {
            errorEl.textContent = 'Connection error. Please try again.';
        }
    });

    // Game created modal
    function showGameCreatedModal(gameId, accessCode, isPublic) {
        const modal = document.getElementById('game-created-modal');
        const gameLink = `${window.location.origin}/game/${gameId}`;

        document.getElementById('game-link').value = gameLink;

        if (!isPublic && accessCode) {
            document.getElementById('access-code-display').style.display = 'block';
            document.getElementById('access-code-value').textContent = accessCode;
        } else {
            document.getElementById('access-code-display').style.display = 'none';
        }

        modal.classList.add('active');

        // Copy code button
        document.getElementById('copy-code-btn').onclick = () => {
            navigator.clipboard.writeText(accessCode);
            showToast('Access code copied!');
        };

        // Copy link button
        document.getElementById('copy-link-btn').onclick = () => {
            navigator.clipboard.writeText(gameLink);
            showToast('Link copied!');
        };

        // iMessage share
        document.getElementById('share-imessage').onclick = () => {
            const message = accessCode
                ? `Join my Texas 42 game! Code: ${accessCode} or link: ${gameLink}`
                : `Join my Texas 42 game! ${gameLink}`;
            window.location.href = `sms:&body=${encodeURIComponent(message)}`;
        };

        // Native share
        document.getElementById('share-native').onclick = async () => {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Join my Texas 42 Game!',
                        text: accessCode ? `Code: ${accessCode}` : 'Come play!',
                        url: gameLink
                    });
                } catch (err) {
                    console.log('Share cancelled');
                }
            } else {
                showToast('Sharing not supported on this device');
            }
        };

        // Go to game button
        document.getElementById('goto-game-btn').onclick = () => {
            window.location.href = `/game/${gameId}`;
        };

        modal.querySelector('.modal-close').onclick = () => {
            modal.classList.remove('active');
        };
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }
});
</script>
{% endblock %}
